<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - GoGreenHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-leaf me-2"></i>GoGreenHub
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <!-- Business Navbar -->
                        <template v-if="isBusinessPartner">
                            <li class="nav-item"><a class="nav-link" href="partner_dashboard.html">Dashboard</a></li>
                            <li class="nav-item"><a class="nav-link" href="directory.html">Directory</a></li>
                            <li class="nav-item"><a class="nav-link" href="forum.html">Community</a></li>
                            <li class="nav-item"><a class="nav-link" href="event.html">Events</a></li>
                            <li class="nav-item" v-if="isLoggedIn">
                                <a class="nav-link active" href="messages_business.html">Messages</a>
                            </li>
                            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                        </template>
                        <!-- Consumer Navbar -->
                        <template v-else>
                            <li class="nav-item">
                                <a class="nav-link" href="index.html">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="directory.html">Directory</a>
                            </li>
                            <li class="nav-item"><a class="nav-link" href="forum.html">Community</a></li>
                            <li class="nav-item"><a class="nav-link" href="event.html">Events</a></li>
                            <li class="nav-item" v-if="isLoggedIn">
                                <a class="nav-link active" href="messages.html">Messages</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="about.html">About</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="contact.html">Contact</a>
                            </li>
                        </template>
                    </ul>
                    
                    <div class="auth-block">
                        
                        <template v-if="!isLoggedIn">
                            <a href="login.html" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-sign-in-alt me-1"></i>Sign In
                            </a>
                            <a href="register.html" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-user-plus me-1"></i>Register
                            </a>
                            <div class="dropdown ms-2" v-if="!isLoggedIn || !isBusinessPartner">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-building me-1"></i>For Businesses
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="register_business.html">
                                    <i class="fas fa-store me-2"></i>Register Green Business
                                </a></li>
                                <li><a class="dropdown-item" href="login_business.html">
                                    <i class="fas fa-sign-in-alt me-2"></i>Business Sign In
                                </a></li>
                            </ul>
                        </div>
                        </template>
                        
                        <template v-else>
                            <!-- Business User Dropdown -->
                            <template v-if="isBusinessPartner">
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-user-circle me-1"></i>{{ userName }}
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item fw-bold" href="partner_dashboard.html">
                                                <i class="fas fa-tachometer-alt me-2"></i>Partner Dashboard
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click.prevent="viewPublicProfile">
                                                <i class="fas fa-eye me-2"></i>View Public Profile
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click.prevent="goToSavedCompanies">
                                                <i class="fas fa-heart me-2 text-danger"></i>Saved Companies
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click.prevent="logout">
                                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </template>
                            <!-- Consumer User Dropdown -->
                            <template v-else>
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm dropdown-toggle position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-user-circle me-1"></i>{{ userName }}
                                        <span v-if="unreadCount > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; padding: 0.2rem 0.3rem;">
                                            {{ unreadCount > 9 ? '9+' : unreadCount }}
                                        </span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item fw-bold d-flex align-items-center justify-content-between" href="user_account.html">
                                                <span><i class="fas fa-user me-2"></i>My Profile</span>
                                                <span v-if="unreadCount > 0" class="badge bg-danger ms-2" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">{{ unreadCount > 9 ? '9+' : unreadCount }}</span>
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="user_account.html#interests">
                                                <i class="fas fa-heart me-2"></i>My Interests
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="user_account.html#profile">
                                                <i class="fas fa-cog me-2"></i>Settings
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="register_business.html">
                                                <i class="fas fa-plus me-2"></i>List Your Business
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <button class="btn btn-outline-light btn-sm" @click="logout">
                                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                                </button>
                            </template>
                        </template>
                    </div>
                    
                </div>
            </div>
        </nav>

    <div class="messaging-container">
        <template v-if="!isLoggedIn">
            <div class="container text-center py-5">
                <h2 class="mb-4">Please log in to view messages</h2>
                <a href="login.html" class="btn btn-success btn-lg">
                    <i class="fas fa-sign-in-alt me-2"></i>Sign In
                </a>
            </div>
        </template>

        <template v-else-if="isBusinessPartner">
            <div class="container text-center py-5">
                <h2 class="mb-4">Business accounts use a different messaging page</h2>
                <a href="messages_business.html" class="btn btn-success btn-lg">
                    <i class="fas fa-comments me-2"></i>Go to Business Messages
                </a>
            </div>
        </template>

        <template v-else-if="!currentUserId && !loadingConversations">
            <div class="text-center p-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Initializing messages...</p>
            </div>
        </template>
        
        <template v-else-if="loadingConversations && currentUserId">
            <div class="text-center p-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading conversations...</span>
                </div>
                <p class="mt-3">Loading conversations...</p>
            </div>
        </template>

        <template v-else-if="currentUserId && !loadingConversations">
            <div class="messaging-wrapper">
                <!-- Conversations Sidebar -->
                <div class="conversations-sidebar" :class="{'hidden': showChat}">
                    <div class="conversations-header">
                        <h3><i class="fas fa-comments me-2"></i>Messages</h3>
                        <div class="search-box">
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Search conversations..."
                                v-model="searchQuery"
                            >
                        </div>
                    </div>
                    
                    <div class="conversations-list">
                        <div v-if="loadingConversations" class="text-center p-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div v-else-if="filteredConversations.length === 0" class="text-center p-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>No conversations yet</p>
                        </div>
                        <div 
                            v-else
                            v-for="conv in filteredConversations" 
                            :key="conv.id"
                            class="conversation-item"
                            :class="{'active': selectedConversation && selectedConversation.id === conv.id}"
                            @click="selectConversation(conv)"
                        >
                            <div class="conversation-avatar">
                                {{ getInitials(conv.businessName) }}
                            </div>
                            <div class="conversation-content">
                                <div class="conversation-top">
                                    <span class="conversation-name">{{ conv.businessName }}</span>
                                    <span class="conversation-time">{{ formatTime(conv.lastMessageTime) }}</span>
                                </div>
                                <div class="conversation-preview">
                                    <span v-if="conv.unread > 0" class="unread-badge">{{ conv.unread }}</span>
                                    {{ conv.lastMessage }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="chat-area" :class="{'mobile-show': showChat}">
                    <div v-if="!selectedConversation" class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h3>Select a conversation</h3>
                        <p>Choose a business from the list to start messaging</p>
                    </div>

                    <template v-else>
                        <!-- Chat Header -->
                        <div class="chat-header">
                            <div class="chat-header-left">
                                <button class="btn btn-sm d-md-none" @click="backToList">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <div class="chat-avatar">
                                    {{ getInitials(selectedConversation.businessName) }}
                                </div>
                                <div class="chat-info">
                                    <h4>{{ selectedConversation.businessName }}</h4>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <button title="View Business Profile" @click="viewBusinessProfile">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Messages Container -->
                        <div class="messages-container" ref="messagesContainer">
                            <div v-if="loadingMessages" class="text-center p-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading messages...</span>
                                </div>
                            </div>
                            <template v-else-if="messages.length === 0">
                                <div class="text-center p-5 text-muted">
                                    <i class="fas fa-comments fa-3x mb-3"></i>
                                    <p>No messages yet. Start the conversation!</p>
                                </div>
                            </template>
                            <template v-else>
                                <div v-for="(group, date) in groupedMessages" :key="date">
                                    <div class="message-date">
                                        <span>{{ date }}</span>
                                    </div>
                                    
                                    <div v-for="msg in group" :key="msg.id" class="message" :class="msg.sent ? 'sent' : 'received'">
                                        <div class="message-bubble">
                                            <div class="message-text">{{ msg.text }}</div>
                                            <div class="message-footer d-flex justify-content-between align-items-center">
                                                <div class="message-time">{{ msg.time }}</div>
                                                <div v-if="msg.sent" class="message-read-status ms-2">
                                                    <i v-if="msg.read_at" class="fas fa-check-double text-primary" title="Read"></i>
                                                    <i v-else class="fas fa-check text-muted" title="Sent"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Message Input -->
                        <div class="message-input-area">
                            <div class="message-input-wrapper">
                                <textarea 
                                    class="message-input" 
                                    placeholder="Type your message..."
                                    v-model="newMessage"
                                    @keydown.enter.exact.prevent="sendMessage"
                                    @keydown.shift.enter.prevent
                                    @keydown.enter.shift.prevent
                                    rows="1"
                                    autocomplete="off"
                                    spellcheck="false"
                                ></textarea>
                                <button 
                                    class="send-button" 
                                    @click="sendMessage"
                                    :disabled="!newMessage.trim() || sendingMessage || !selectedConversation"
                                    title="Send message"
                                >
                                    <i v-if="!sendingMessage" class="fas fa-paper-plane"></i>
                                    <i v-else class="fas fa-spinner fa-spin"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        </div>
    </div> <!-- Close #app div -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
    import { authMixin } from './js/auth-mixin.js';
    import { notificationMixin } from './js/notification-mixin.js';

    const { createApp } = Vue;

    createApp({
        mixins: [authMixin, notificationMixin],
        data() {
            return {
                currentUserId: null,
                searchQuery: '',
                selectedConversation: null,
                newMessage: '',
                showChat: false,
                conversations: [],
                messages: [],
                loadingConversations: true,
                loadingMessages: false,
                sendingMessage: false,
                pollingInterval: null,
                messagesPollingInterval: null,
                lastMessageId: null
            };
        },
        computed: {
            filteredConversations() {
                if (!this.searchQuery) return this.conversations;
                return this.conversations.filter(conv => 
                    conv.businessName.toLowerCase().includes(this.searchQuery.toLowerCase())
                );
            },
            groupedMessages() {
                if (this.messages.length === 0) return {};
                
                const groups = {};
                this.messages.forEach(msg => {
                    const date = this.formatDate(msg.timestamp);
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(msg);
                });
                return groups;
            }
           
        },
        watch: {
            isLoggedIn(newVal) {
                if (newVal) {
                    this.$nextTick(() => {
                        if (this.userId) {
                            this.currentUserId = this.userId.toString();
                            this.loadUserData(this.userId);
                       
                            const urlParams = new URLSearchParams(window.location.search);
                            const businessId = urlParams.get('business_id');
                            if (businessId) {
                                sessionStorage.setItem('openConversation', businessId);
                            }
                            
                    this.loadConversations(true);
                } else {
                            setTimeout(() => {
                                if (this.userId) {
                                    this.currentUserId = this.userId.toString();
                                    this.loadUserData(this.userId);
                                    
                                    const urlParams = new URLSearchParams(window.location.search);
                                    const businessId = urlParams.get('business_id');
                                    if (businessId) {
                                        sessionStorage.setItem('openConversation', businessId);
                                    }
                                    
                                    this.loadConversations(true);
                                }
                            }, 500);
                        }
                    });
                } else {
                    this.currentUserId = null;
                }
            }
        },
        async mounted() {
            const urlParams = new URLSearchParams(window.location.search);
            const businessId = urlParams.get('business_id');
            if (businessId) {
                console.log('Business ID found in URL:', businessId);
                sessionStorage.setItem('openConversation', businessId);
            }
            this.$nextTick(() => {
                const checkAuthAndLoad = () => {
                    if (this.isLoggedIn && this.userId) {
                        this.currentUserId = this.userId.toString();
                        this.loadUserData(this.userId);
                        this.loadConversations(true);
                        console.log('Auth ready, loading conversations. Business ID to open:', businessId);
                    } else {
                        let attempts = 0;
                        const maxAttempts = 25;
                        const checkInterval = setInterval(() => {
                            attempts++;
                            if (this.isLoggedIn && this.userId) {
                                clearInterval(checkInterval);
                                this.currentUserId = this.userId.toString();
                                this.loadUserData(this.userId);
                                this.loadConversations(true);
                                console.log('Auth ready after retry, loading conversations');
                            } else if (attempts >= maxAttempts) {
                                clearInterval(checkInterval);
                                if (businessId) {
                                    console.log('Auth not ready after max attempts, but business_id is set:', businessId);
                                }
                            }
                        }, 200);
                    }
                };
                
                setTimeout(checkAuthAndLoad, 500);
            });
        },
        methods: {
            async loadUserData(userId) {
                try {
                    const resp = await fetch(`api/data.php?action=get_user_name&user_id=${userId}`, {
                        credentials: 'include'
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.success && data.name) {
                            this.userName = data.name;
                        return;
                    }
                    }
                } catch (error) {
                    console.error('Error loading user data from MySQL:', error);
                }
                
            },
            async loadConversations(showLoading = false) {
                if (!this.currentUserId) return;
                
                if (showLoading) {
                this.loadingConversations = true;
                }
                
                try {
                    const response = await fetch('api/messages.php?action=conversations', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Session expired. Please log in again.');
                            window.location.href = 'login.html';
                        return;
                        }
                        throw new Error('Failed to load conversations');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const newConversations = data.conversations.map(conv => {
                            let lastMessageTime = conv.last_message_time || null;
                            if (lastMessageTime && typeof lastMessageTime === 'string' && lastMessageTime.startsWith('2025-')) {
                                lastMessageTime = lastMessageTime.replace('2025-', '2024-');
                            }
                            
                            return {
                                id: conv.id,
                                businessId: conv.business_id,
                                businessName: conv.business_name || 'Business',
                                lastMessage: conv.last_message || '',
                                lastMessageTime: lastMessageTime,
                                unread: conv.unread_count || 0
                            };
                        });
                        
                        const existingMap = new Map();
                        this.conversations.forEach(conv => {
                            existingMap.set(conv.id, conv);
                        });
                        
                        let hasChanged = false;
                        const newMap = new Map();
                        newConversations.forEach(newConv => {
                            newMap.set(newConv.id, newConv);
                            const oldConv = existingMap.get(newConv.id);
                            if (!oldConv || 
                                oldConv.lastMessage !== newConv.lastMessage ||
                                oldConv.lastMessageTime !== newConv.lastMessageTime ||
                                oldConv.unread !== newConv.unread ||
                                oldConv.businessName !== newConv.businessName) {
                                hasChanged = true;
                            }
                        });
                        if (this.conversations.length !== newConversations.length) {
                            hasChanged = true;
                        }
                        
                        if (hasChanged || this.conversations.length === 0) {
                         
                            if (this.conversations.length > 0) {
                                newConversations.forEach(newConv => {
                                    const existing = existingMap.get(newConv.id);
                                    if (existing) {
                                        existing.lastMessage = newConv.lastMessage;
                                        existing.lastMessageTime = newConv.lastMessageTime;
                                        existing.unread = newConv.unread;
                                        existing.businessName = newConv.businessName;
                                    } else {
                                        this.conversations.push(newConv);
                                    }
                                });
                                
                                this.conversations = this.conversations.filter(conv => newMap.has(conv.id));
                            } else {
                                this.conversations = newConversations;
                            }
                            
                            this.conversations.sort((a, b) => {
                                const timeA = a.lastMessageTime ? new Date(a.lastMessageTime.replace('2025-', '2024-')) : new Date(0);
                                const timeB = b.lastMessageTime ? new Date(b.lastMessageTime.replace('2025-', '2024-')) : new Date(0);
                                return timeB.getTime() - timeA.getTime();
                            });
                        }
                        
                        this.loadingConversations = false;
                        if (this.conversations.length > 0 && !this.selectedConversation) {
                        this.autoOpenConversation();
                        }
                        
                        if (!this.pollingInterval) {
                            this.pollingInterval = setInterval(() => this.loadConversations(false), 5000); 
                        }
                                } else {
                        throw new Error(data.error || 'Failed to load conversations');
                    }
                } catch (error) {
                    console.error('Error loading conversations:', error);
                    this.loadingConversations = false;
                    this.conversations = [];
                }
            },

            async getBusinessName(businessId) {
                try {
                   
                    const response = await fetch(`api/data.php?action=get_business_name&business_id=${businessId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.name) {
                            return data.name;
                        }
                    }
                } catch (error) {
                    console.error('Error getting business name:', error);
                }
                return 'Business';
            },
            async selectConversation(conv) {
                console.log('Selecting conversation:', conv);
                this.selectedConversation = conv;
                conv.unread = 0;
                this.showChat = true;
                
                this.newMessage = '';
             
                if (conv.id) {
                    this.loadMessages(conv.id);
                } else {
                  
                    this.messages = [];
                    this.loadingMessages = false;
                    console.log('New conversation - no messages to load yet');
                }
                
                this.$nextTick(() => {
                    this.scrollToBottom();
                   
                    const textarea = document.querySelector('.message-input');
                    if (textarea) {
                        textarea.blur();
                    }
                });
            },
            async loadMessages(conversationId) {
                if (!conversationId) return;
                
                this.loadingMessages = true;
                this.messages = [];
              
                if (this.messagesPollingInterval) {
                    clearInterval(this.messagesPollingInterval);
                }
                
                try {
                    const response = await fetch(`api/messages.php?action=messages&conversation_id=${conversationId}`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load messages');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                      
                    const sessionResp = await fetch('api/bridge.php?action=get_user', {
                        credentials: 'include'
                    });
                    let sessionData = null;
                    if (sessionResp.ok) {
                        sessionData = await sessionResp.json();
                    }
                        const currentUserId = sessionData?.success ? sessionData.user.userId : null;
                        
                        this.messages = data.messages.map(msg => {
                           
                            let timestampStr = msg.timestamp;
                            if (typeof timestampStr === 'string' && timestampStr.startsWith('2025-')) {
                                timestampStr = timestampStr.replace('2025-', '2024-');
                            }
                            
                            return {
                                id: msg.id,
                                text: msg.text,
                                senderId: msg.sender_id,
                                senderName: msg.sender_name,
                                sent: currentUserId && msg.sender_id == currentUserId,
                                timestamp: new Date(timestampStr),
                                time: this.formatTime(timestampStr),
                                read_at: msg.read_at || null
                            };
                        });
                        
                        this.lastMessageId = this.messages.length > 0 ? this.messages[this.messages.length - 1].id : null;
                        this.loadingMessages = false;
                        
                        this.$nextTick(() => {
                            this.scrollToBottom();
                        });
                        
                        this.messagesPollingInterval = setInterval(() => {
                            this.pollMessages(conversationId);
                        }, 3000); 
                    } else {
                        throw new Error(data.error || 'Failed to load messages');
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                    this.loadingMessages = false;
                }
            },
            
            async pollMessages(conversationId) {
                try {
                    const response = await fetch(`api/messages.php?action=messages&conversation_id=${conversationId}`, {
                        method: 'GET',
                    credentials: 'include'
                });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.success && data.messages.length > 0) {
                            const lastMsg = data.messages[data.messages.length - 1];
                            if (lastMsg.id !== this.lastMessageId) {
                                this.loadMessages(conversationId);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error polling messages:', error);
                }
            },
            async sendMessage() {
                
                const messageText = this.newMessage.trim();
                if (!messageText || !this.selectedConversation || this.sendingMessage) return;
                
                if (messageText.length === 0) return;
                
                this.sendingMessage = true;
                
                try {
                    const conversationId = this.selectedConversation.id;
                
                    const requestBody = conversationId 
                        ? { conversation_id: conversationId, text: messageText }
                        : { business_id: this.selectedConversation.businessId, text: messageText };
                    
                    const response = await fetch('api/messages.php?action=send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send message');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (data.message) {
                           
                            let timestampStr = data.message.timestamp;
                            if (typeof timestampStr === 'string' && timestampStr.startsWith('2025-')) {
                                timestampStr = timestampStr.replace('2025-', '2024-');
                            }
                            
                            const newMsg = {
                                id: data.message.id,
                                text: data.message.text,
                                senderId: data.message.sender_id,
                                senderName: data.message.sender_name,
                                sent: true,
                                timestamp: new Date(timestampStr),
                                time: this.formatTime(timestampStr),
                                read_at: null
                            };
                            this.messages.push(newMsg);
                            this.lastMessageId = newMsg.id;
                        }
                       
                        if (this.selectedConversation) {
                         
                            if (!this.selectedConversation.id && data.conversation_id) {
                                this.selectedConversation.id = data.conversation_id;
                                this.loadMessages(data.conversation_id);
                            }
                            
                            if (this.selectedConversation.id === data.conversation_id) {
                                this.selectedConversation.lastMessage = data.message?.text || '';
                                let timestamp = data.message?.timestamp || '';
                                if (timestamp && typeof timestamp === 'string' && timestamp.startsWith('2025-')) {
                                    timestamp = timestamp.replace('2025-', '2024-');
                                }
                                this.selectedConversation.lastMessageTime = timestamp;
                                
                                if (data.message && !data.message.sent) {
                                    this.selectedConversation.unread = (this.selectedConversation.unread || 0) + 1;
                                }
                            }
                        }
                        this.newMessage = '';
                        this.$nextTick(() => {
                            if (this.newMessage !== '') {
                                this.newMessage = '';
                            }
                        });
                        
                        setTimeout(() => {
                            this.scrollToBottom();
                        }, 100);
                    } else {
                        throw new Error(data.error || 'Failed to send message');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Error sending message: ' + (error.message || 'Please try again.'));
                } finally {
                    this.sendingMessage = false;
                }
            },
            async createConversation(businessId) {
                if (!businessId) return;
                
                try {
                    const response = await fetch('api/messages.php?action=create_conversation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            business_id: businessId
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            return data.conversation_id;
                        }
                    }
                    
                    throw new Error('Failed to create conversation');
                } catch (error) {
                    console.error('Error creating conversation:', error);
                    throw error;
                }
            },
            
            beforeUnmount() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
                if (this.messagesPollingInterval) {
                    clearInterval(this.messagesPollingInterval);
                }
            },
            backToList() {
                this.showChat = false;
            },
            viewBusinessProfile() {
                if (this.selectedConversation && this.selectedConversation.businessId) {
                    window.location.href = `business_profile.html?id=${this.selectedConversation.businessId}`;
                }
            },
            scrollToBottom() {
                this.$nextTick(() => {
                    setTimeout(() => {
                const container = this.$refs.messagesContainer;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
                    }, 50);
                });
            },
            getInitials(name) {
                if (!name) return '?';
                const parts = name.split(' ');
                if (parts.length > 1) {
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                }
                return name[0].toUpperCase();
            },
            formatTime(date) {
                if (!date) return '';
                
                let d;
                let originalInput = date;
                
                if (typeof date === 'string') {
                
                    let normalized = date.trim();
                    const currentYear = new Date().getFullYear();
                    const timestampYear = parseInt(normalized.substring(0, 4));
                  
                    if (timestampYear === currentYear - 1 || timestampYear === currentYear + 1) {
                        normalized = normalized.replace(/^\d{4}/, currentYear.toString());
                        console.log('Auto-corrected year from', timestampYear, 'to', currentYear, ':', date, '->', normalized);
                    }
                    
                    if (normalized.includes(' ') && !normalized.includes('T')) {
                      
                        const parts = normalized.split(' ');
                        if (parts.length === 2) {
                            const datePart = parts[0].split('-');
                            const timePart = parts[1].split(':');
                            if (datePart.length === 3 && timePart.length === 3) {
                                d = new Date(
                                    parseInt(datePart[0]),     
                                    parseInt(datePart[1]) - 1,  
                                    parseInt(datePart[2]),     
                                    parseInt(timePart[0]),      
                                    parseInt(timePart[1]),      
                                    parseInt(timePart[2])       
                                );
                            } else {
                                normalized = normalized.replace(' ', 'T');
                                d = new Date(normalized);
                            }
                        } else {
                            normalized = normalized.replace(' ', 'T');
                            d = new Date(normalized);
                        }
                    } else {
                        d = new Date(normalized);
                    }
                } else if (date instanceof Date) {
                    d = new Date(date); 
                    const currentYear = new Date().getFullYear();
                    const dateYear = d.getFullYear();
                  
                    if (dateYear === currentYear - 1 || dateYear === currentYear + 1) {
                        d.setFullYear(currentYear);
                        console.log('Auto-corrected Date object year from', dateYear, 'to', currentYear, 'original:', date);
                    }
                } else {
                    d = new Date(date);
                }
                
                if (isNaN(d.getTime())) {
                    console.error('Invalid timestamp:', date);
                    return '';
                }
                
                const now = new Date();
                const diffMs = now.getTime() - d.getTime();
                let diff = Math.floor(diffMs / 1000);
                console.log('Message timestamp calculation:', {
                    timestamp: date,
                    parsedDate: d.toISOString(),
                    localDate: d.toString(),
                    now: now.toISOString(),
                    nowLocal: now.toString(),
                    diffMs: diffMs,
                    diffSeconds: diff,
                    diffHours: Math.floor(diff / 3600)
                });
                
                if (diff < 0) {
                    const yearDiff = now.getFullYear() - d.getFullYear();
                  
                    if (yearDiff === -1 && Math.abs(diff) < 400 * 24 * 3600) { 
                        d.setFullYear(d.getFullYear() - 1);
                        diff = Math.floor((now.getTime() - d.getTime()) / 1000);
                        console.log('Adjusted future date year, new diff:', diff, 'seconds');
                    } else {
                        console.log('Future date detected, showing Just now. Original:', originalInput, 'Parsed:', d, 'Diff:', diff);
                        return 'Just now'; 
                    }
                }
                
                if (diff < 0) return 'Just now';
                if (diff < 60) return 'Just now';
          
                if (diff < 3600) {
                    const mins = Math.floor(diff / 60);
                    return mins === 1 ? '1 min ago' : mins + ' min ago';
                }
                
                if (diff < 86400) {
                    const hours = Math.floor(diff / 3600);
                    if (hours < 6) {
                        return hours === 1 ? '1 hour ago' : hours + ' hours ago';
                    } else {
                        return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                    }
                }
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const msgDate = new Date(d);
                msgDate.setHours(0, 0, 0, 0);
                if (msgDate.getTime() === yesterday.getTime()) {
                    return 'Yesterday ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                if (msgDate.getTime() === today.getTime()) {
                    return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                if (diff < 604800) {
                    const days = Math.floor(diff / 86400);
                    if (days === 1) {
                        return 'Yesterday';
                    } else {
                        return days + ' days ago';
                    }
                }
                
                if (diff < 2592000) {
                    const weeks = Math.floor(diff / 604800);
                    return weeks === 1 ? '1 week ago' : weeks + ' weeks ago';
                }
                
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            },
            formatDate(date) {
                if (!date) return '';
                
                let d;
                if (typeof date === 'string') {
                    let normalized = date.trim();
                    
                    const currentYear = new Date().getFullYear();
                    const timestampYear = parseInt(normalized.substring(0, 4));
                    
                    if (timestampYear === currentYear - 1 || timestampYear === currentYear + 1) {
                        normalized = normalized.replace(/^\d{4}/, currentYear.toString());
                        console.log('Auto-corrected date year from', timestampYear, 'to', currentYear, ':', date, '->', normalized);
                    }
                    
                    if (normalized.includes(' ') && !normalized.includes('T')) {
                        normalized = normalized.replace(' ', 'T');
                    }
                    d = new Date(normalized);
                } else if (date instanceof Date) {
                    d = new Date(date); 
                    const currentYear = new Date().getFullYear();
                    const dateYear = d.getFullYear();
                    if (dateYear === currentYear - 1 || dateYear === currentYear + 1) {
                        d.setFullYear(currentYear);
                        console.log('Auto-corrected Date object year from', dateYear, 'to', currentYear, 'original:', date);
                    }
                } else {
                    d = new Date(date);
                }
                if (isNaN(d.getTime())) {
                    return '';
                }
                
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (d.toDateString() === today.toDateString()) return 'Today';
                if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
                return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            },
            async autoOpenConversation() {
                const businessIdToOpen = sessionStorage.getItem('openConversation');
                if (businessIdToOpen && this.currentUserId) {
                    console.log('Auto-opening conversation for business ID:', businessIdToOpen);
                    sessionStorage.removeItem('openConversation');
                    
                    try {
                        const businessId = parseInt(businessIdToOpen);
                        
                        let conversation = this.conversations.find(c => c.businessId == businessId);
                        
                        if (!conversation) {
                            console.log('No existing conversation found, creating placeholder...');
                            
                            const response = await fetch(`api/data.php?action=get_business_name&business_id=${businessId}`, {
                            credentials: 'include'
                        });
                            let businessName = 'Business';
                            if (response.ok) {
                                const data = await response.json();
                                if (data.success && data.name) {
                                    businessName = data.name;
                                }
                            }
                            // createConversation which auto-sends "Hi"
                            conversation = {
                                id: null, 
                                businessId: businessId,
                                businessName: businessName,
                                lastMessage: '',
                                lastMessageTime: null,
                                unread: 0
                            };
                            this.conversations.unshift(conversation);
                            console.log('Added placeholder conversation to list:', conversation);
                        }
                        
                        console.log('Selecting conversation:', conversation);
                        this.selectConversation(conversation);
                    } catch (error) {
                        console.error('Error auto-opening conversation:', error);
                        alert('Error opening conversation: ' + (error.message || 'Please try again.'));
                    }
                }
            },
        },
        watch: {
            isLoggedIn(newVal) {
               
                if (newVal && this.currentUserId) {
                    const businessIdToOpen = sessionStorage.getItem('openConversation');
                    if (businessIdToOpen) {
                        console.log('User logged in, will auto-open conversation for:', businessIdToOpen);
                       
                        setTimeout(() => {
                            this.autoOpenConversation();
                        }, 1000);
                    }
                }
            },
            conversations: {
                handler(newVal, oldVal) {
                
                    const businessIdToOpen = sessionStorage.getItem('openConversation');
                    if (businessIdToOpen && newVal.length > 0 && this.currentUserId && this.isLoggedIn) {
                        console.log('Conversations loaded, auto-opening conversation for:', businessIdToOpen);
                        this.$nextTick(() => {
                            this.autoOpenConversation();
                        });
                    }
                },
                immediate: false
            },
            loadingConversations(newVal) {
                // When conversations finish loading (whether empty or not), check if we need to auto-open
                if (!newVal && this.isLoggedIn && this.currentUserId) {
                    const businessIdToOpen = sessionStorage.getItem('openConversation');
                    if (businessIdToOpen) {
                        console.log('Conversations finished loading, will try to auto-open conversation for:', businessIdToOpen);
                        setTimeout(() => {
                            this.autoOpenConversation();
                        }, 800);
                    }
                }
            },
            currentUserId(newVal) {
                if (newVal && this.isLoggedIn) {
                    const businessIdToOpen = sessionStorage.getItem('openConversation');
                    if (businessIdToOpen) {
                        console.log('Current user ID set, will auto-open conversation for:', businessIdToOpen);
                        setTimeout(() => {
                            this.autoOpenConversation();
                        }, 1000);
                    }
                }
            }
        }
    }).mount('#app');
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
        
        navLinks.forEach(link => {
            link.classList.remove('active');
            const linkHref = link.getAttribute('href');
            if (linkHref && (linkHref === currentPage || (currentPage === '' && linkHref === 'index.html'))) {
                link.classList.add('active');
            }
        });
    });
</script>
</body>
</html>
