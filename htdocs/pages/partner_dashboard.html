<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Dashboard - GoGreenHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="partner_dashboard.html">
                    <i class="fas fa-leaf me-2"></i>GoGreenHub
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto">
                            <li class="nav-item"><a class="nav-link" href="partner_dashboard.html">Dashboard</a></li>
                            <li class="nav-item"><a class="nav-link" href="directory.html">Directory</a></li>
                            <li class="nav-item"><a class="nav-link" href="forum.html">Community</a></li>
                            <li class="nav-item"><a class="nav-link" href="event.html">Events</a></li>
                            <li class="nav-item"><a class="nav-link" href="messages_business.html">Messages</a></li>
                            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                        </ul>
                    
                    <div class="auth-block">
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>{{ businessName || userName || 'Business' }}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item fw-bold" href="#" @click.prevent="activeTab = 'overview'">
                                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a 
                                        class="dropdown-item" 
                                        href="#"
                                        @click="viewPublicProfile"
                                    >
                                    <i class="fas fa-eye me-2"></i>View Public Profile
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a 
                                        class="dropdown-item" 
                                        href="#"
                                        @click.prevent="activeTab = 'interests'"
                                    >
                                    <i class="fas fa-heart me-2 text-danger"></i>Saved Companies
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" @click.prevent="logout">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="container mt-4 mb-5">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-3 mb-4">
                    <div class="dashboard-sidebar">
                        <div style="background: #2e7d32; color: white; padding: 20px;">
                            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h5>
                        </div>
                        <ul class="sidebar-menu">
                            <li>
                                <a href="#" @click.prevent="activeTab = 'overview'" :class="{active: activeTab === 'overview'}">
                                    <i class="fas fa-home me-2"></i>Overview
                                </a>
                            </li>
                            <li>
                                <a href="#" @click.prevent="activeTab = 'profile'" :class="{active: activeTab === 'profile'}">
                                    <i class="fas fa-building me-2"></i>Business Profile
                                </a>
                            </li>
                            <li>
                                <a href="#" @click.prevent="activeTab = 'certifications'" :class="{active: activeTab === 'certifications'}">
                                    <i class="fas fa-certificate me-2"></i>Certifications
                                </a>
                            </li>
                            <li>
                                <a href="#" @click.prevent="activeTab = 'practices'" :class="{active: activeTab === 'practices'}">
                                    <i class="fas fa-leaf me-2"></i>Eco Practices
                                </a>
                            </li>
                            <li>
                                <a href="#" @click.prevent="activeTab = 'products'" :class="{active: activeTab === 'products'}">
                                    <i class="fas fa-box me-2"></i>Add Product and Services
                                </a>
                            </li>
                            <li>
                                <a href="#" @click.prevent="activeTab = 'interests'" :class="{active: activeTab === 'interests'}">
                                    <i class="fas fa-heart me-2"></i>Saved Companies
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <!-- Overview Tab -->
                    <div v-if="activeTab === 'overview'">
                        <h2 class="mb-4">Welcome back, {{ businessName }}!</h2>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <div class="stat-widget">
                                    <h3>{{ stats.certifications }}</h3>
                                    <p class="mb-0">Active Certifications</p>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <h4 class="mb-3"><i class="fas fa-chart-line me-2 text-success"></i>Quick Actions</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-success w-100" @click="activeTab = 'profile'">
                                        <i class="fas fa-edit me-2"></i>Update Business Info
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-success w-100" @click="activeTab = 'certifications'">
                                        <i class="fas fa-certificate me-2"></i>Upload Certificate
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-success w-100" @click="activeTab = 'practices'">
                                        <i class="fas fa-leaf me-2"></i>Add Practice
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-success w-100" @click="activeTab = 'products'">
                                        <i class="fas fa-box me-2"></i>Add Product and Services
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Business Profile Tab -->
                    <div v-if="activeTab === 'profile'">
                        <h2 class="mb-4">Business Profile</h2>
                        <div class="dashboard-card">
                            <form @submit.prevent="updateProfile">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Business Name</label>
                                        <input type="text" class="form-control" v-model="profile.name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Category</label>
                                        <select class="form-select" v-model="profile.category">
                                            <option value="Technology">Technology</option>
                                            <option value="Food and Beverage">Food and Beverage</option>
                                            <option value="Energy">Energy</option>
                                            <option value="Retail">Retail</option>
                                            <option value="Manufacturing">Manufacturing</option>
                                            <option value="Services">Services</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Description</label>
                                        <textarea class="form-control" rows="4" v-model="profile.description"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Address</label>
                                        <input type="text" class="form-control" v-model="profile.address" placeholder="e.g., 123 Main St, Singapore" id="address-input">
                                        <small class="text-muted">Enter address or use Google Maps API to autofill</small>
                                        <!-- Hidden fields for lat/lng from Google Maps API -->
                                        <input type="hidden" v-model="profile.lat" id="address-lat">
                                        <input type="hidden" v-model="profile.lng" id="address-lng">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Phone</label>
                                        <input type="tel" class="form-control" v-model="profile.phone" placeholder="+65 1234 5678" @input="filterPhoneNumber">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Email</label>
                                        <input type="email" class="form-control" v-model="profile.email">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Website</label>
                                        <input type="url" class="form-control" v-model="profile.website" placeholder="https://example.com">
                                    </div>
                                </div>
                                <h6 class="mt-4 mb-3">Change Password</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="password" class="form-control" v-model="passwordData.currentPassword" placeholder="Current Password">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="password" class="form-control" v-model="passwordData.newPassword" placeholder="New Password">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="password" class="form-control" v-model="passwordData.confirmPassword" placeholder="Confirm New Password">
                                    </div>
                                </div>
                                <div class="alert alert-success mt-3" v-if="profileUpdateMessage">
                                    <i class="fas fa-check-circle me-2"></i>{{ profileUpdateMessage }}
                                </div>
                                <div class="alert alert-success mt-3" v-if="passwordMessage && passwordMessageType === 'success'">
                                    <i class="fas fa-check-circle me-2"></i>{{ passwordMessage }}
                                </div>
                                <div class="alert alert-danger mt-3" v-if="passwordMessage && passwordMessageType === 'error'">
                                    <i class="fas fa-exclamation-circle me-2"></i>{{ passwordMessage }}
                                </div>
                                <button type="submit" class="btn btn-success mt-3">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Certifications Tab -->
                    <div v-if="activeTab === 'certifications'">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="mb-0">Certifications</h2>
                            <button class="btn btn-success" @click="showAddCert = true">
                                <i class="fas fa-plus me-2"></i>Add Certification
                            </button>
                        </div>

                        <div v-if="showAddCert" class="dashboard-card mb-4">
                            <h4 class="mb-3">Add New Certification</h4>
                            <form @submit.prevent="addCertification">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Certification Name</label>
                                        <select class="form-select" v-model="newCert.name" required>
                                            <option value="">Select a Certification</option>
                                            <option value="BCA Green Mark">BCA Green Mark</option>
                                            <option value="Singapore Green Label (SGLS)">Singapore Green Label (SGLS)</option>
                                            <option value="Singapore Green Building Product (SGBP)">Singapore Green Building Product (SGBP)</option>
                                            <option value="Eco Office Certification">Eco Office Certification</option>
                                            <option value="Eco Shop / Eco F&B">Eco Shop / Eco F&B</option>
                                            <option value="LowCarbonSG Mark">LowCarbonSG Mark</option>
                                            <option value="Zero Waste SG Certification">Zero Waste SG Certification</option>
                                            <option value="SS ISO 14001 (Environmental Management)">SS ISO 14001 (Environmental Management)</option>
                                            <option value="SS ISO 50001 (Energy Management)">SS ISO 50001 (Energy Management)</option>
                                            <option value="Carbon Neutral / CarbonNeutral®">Carbon Neutral / CarbonNeutral®</option>
                                            <option value="Climate Neutral Certified">Climate Neutral Certified</option>
                                            <option value="B Corp">B Corp</option>
                                            <option value="LEED Certification">LEED Certification</option>
                                            <option value="ISO 26000 (Social Responsibility)">ISO 26000 (Social Responsibility)</option>
                                            <option value="Cradle to Cradle Certified™">Cradle to Cradle Certified™</option>
                                            <option value="Green Globe Certification">Green Globe Certification</option>
                                            <option value="Fair Trade Certified">Fair Trade Certified</option>
                                            <option value="Energy Star">Energy Star</option>
                                            <option value="Carbon Disclosure Project (CDP)">Carbon Disclosure Project (CDP)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Certificate Number</label>
                                        <input type="text" class="form-control" v-model="newCert.code" required placeholder="Enter certificate number">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Issue Date</label>
                                        <input 
                                            type="date" 
                                            class="form-control" 
                                            v-model="newCert.issued" 
                                            :max="maxIssueDate" 
                                            @change="validateIssueDate"
                                            @input="validateIssueDate"
                                            required>
                                        <small class="text-muted">Issue date cannot be in the future</small>
                                        <div v-if="certValidationErrors.issued" class="text-danger small mt-1">
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ certValidationErrors.issued }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Expiry Date</label>
                                        <input type="date" class="form-control" v-model="newCert.expiry" :min="minExpiryDate" required>
                                        <small class="text-muted">Expiry date must be after issue date</small>
                                        <div v-if="certValidationErrors.expiry" class="text-danger small mt-1">
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ certValidationErrors.expiry }}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-success me-2">
                                        <i class="fas fa-check me-2"></i>Add
                                    </button>
                                    <button type="button" class="btn btn-secondary" @click="showAddCert = false">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div v-for="(cert, index) in certifications" :key="index" class="cert-item">
                            <div>
                                <h5 class="mb-1"><i class="fas fa-award me-2 text-warning"></i>{{ cert.name }}</h5>
                                <small class="text-muted d-block" v-if="cert.code">Code: {{ cert.code }}</small>
                                <small class="text-muted" v-if="cert.issued && cert.expiry">Valid: {{ cert.issued }} to {{ cert.expiry }}</small>
                                <small class="text-muted" v-else-if="cert.issued">Issued: {{ cert.issued }}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" @click="removeCertification(index)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Eco Practices Tab -->
                    <div v-if="activeTab === 'practices'">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="mb-0">Eco-Friendly Practices</h2>
                            <button class="btn btn-success" @click="showAddPractice = true">
                                <i class="fas fa-plus me-2"></i>Add Practice
                            </button>
                        </div>

                        <div v-if="showAddPractice" class="dashboard-card mb-4">
                            <h4 class="mb-3">Add New Practice</h4>
                            <form @submit.prevent="addPractice">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Practice Title</label>
                                    <input type="text" class="form-control" v-model="newPractice.title" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" rows="3" v-model="newPractice.description" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-success me-2">
                                    <i class="fas fa-check me-2"></i>Add
                                </button>
                                <button type="button" class="btn btn-secondary" @click="showAddPractice = false">
                                    Cancel
                                </button>
                            </form>
                        </div>

                        <div v-for="(practice, index) in ecoPractices" :key="index" class="eco-practice-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="mb-2"><i class="fas fa-check-circle me-2 text-success"></i>{{ practice.title }}</h5>
                                    <p class="mb-0 text-muted">{{ practice.description }}</p>
                                </div>
                                <button class="btn btn-sm btn-outline-danger ms-3" @click="removePractice(index)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Products Tab -->
                    <div v-if="activeTab === 'products'">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="mb-0">Products & Services</h2>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" @click="showCSVImport = true">
                                    <i class="fas fa-file-csv me-2"></i>Import CSV
                                </button>
                                <button class="btn btn-success" @click="showAddProduct = true">
                                    <i class="fas fa-plus me-2"></i>Add
                                </button>
                            </div>
                        </div>

                        <!-- CSV Import Modal -->
                        <div v-if="showCSVImport" class="dashboard-card mb-4">
                            <h4 class="mb-3"><i class="fas fa-file-csv me-2"></i>Import Products from CSV</h4>
                            
                            <!-- CSV File Upload -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Select CSV File</label>
                                <input 
                                    type="file" 
                                    class="form-control" 
                                    accept=".csv" 
                                    @change="handleCSVFileSelect"
                                    ref="csvFileInput"
                                >
                                <small class="text-muted">
                                    CSV format: Name, Description (one product per row)
                                </small>
                            </div>
                            
                            <!-- Bulk Image Upload (after CSV is loaded) -->
                            <div v-if="importedProducts.length > 0" class="mb-3">
                                <label class="form-label fw-bold">Upload Product Images (Optional)</label>
                                <input 
                                    type="file" 
                                    class="form-control" 
                                    accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                    multiple
                                    @change="handleBulkImageUpload"
                                    ref="bulkImageInput"
                                >
                                <small class="text-muted">
                                    Select multiple images (one per product). Images will be matched by order (first image for first product, etc.)
                                </small>
                            </div>

                            <!-- Imported Products Preview -->
                            <div v-if="importedProducts.length > 0" class="mb-4">
                                <h5 class="mb-3">Preview Imported Products ({{ importedProducts.length }} items)</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Name *</th>
                                                <th>Description</th>
                                                <th>Image</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(product, index) in importedProducts" :key="index">
                                                <td>
                                                    <input 
                                                        type="text" 
                                                        class="form-control form-control-sm" 
                                                        v-model="product.name"
                                                    >
                                                </td>
                                                <td>
                                                    <textarea 
                                                        class="form-control form-control-sm" 
                                                        rows="2"
                                                        v-model="product.description"
                                                    ></textarea>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-column align-items-center">
                                                        <input 
                                                            type="file" 
                                                            class="form-control form-control-sm mb-2" 
                                                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                                            @change="handleProductImageUpload(index, $event)"
                                                            :ref="'productImageInput' + index"
                                                        >
                                                        <div v-if="product.imagePreview" class="mt-1">
                                                            <img :src="product.imagePreview" alt="Product preview" class="img-thumbnail" style="max-width: 80px; max-height: 80px; object-fit: cover;">
                                                            <button type="button" class="btn btn-sm btn-danger mt-1" @click="removeProductImageFromImport(index)" style="width: 100%;">
                                                                <i class="fas fa-times me-1"></i>Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <button 
                                                        class="btn btn-sm btn-outline-danger" 
                                                        @click="removeImportedProduct(index)"
                                                        title="Remove"
                                                    >
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex gap-2 mt-3">
                                    <button 
                                        class="btn btn-success" 
                                        @click="saveImportedProducts"
                                        :disabled="savingProducts"
                                    >
                                        <i class="fas fa-save me-2"></i>
                                        {{ savingProducts ? 'Saving...' : 'Save All Products' }}
                                    </button>
                                    <button 
                                        class="btn btn-secondary" 
                                        @click="cancelCSVImport"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div v-if="showAddProduct" class="dashboard-card mb-4">
                            <h4 class="mb-3">{{ editingProductIndex !== null ? 'Edit Product/Service' : 'Add New Product/Service' }}</h4>
                            <form @submit.prevent="editingProductIndex !== null ? updateProduct() : addProduct()">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Name</label>
                                        <input type="text" class="form-control" v-model="newProduct.name" required>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Description</label>
                                        <textarea class="form-control" rows="3" v-model="newProduct.description" required></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Product Image</label>
                                        <input 
                                            type="file" 
                                            class="form-control" 
                                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                            @change="handleProductImageChange"
                                            ref="productImageInput"
                                        >
                                        <small class="text-muted">Maximum file size: 5MB. Supported formats: JPG, PNG, GIF, WEBP</small>
                                        <div v-if="newProduct.imagePreview" class="mt-2">
                                            <img :src="newProduct.imagePreview" alt="Product preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                            <button type="button" class="btn btn-sm btn-danger ms-2" @click="removeProductImage">
                                                <i class="fas fa-times me-1"></i>Remove Image
                                            </button>
                                        </div>
                                        <div v-else-if="editingProductIndex !== null && products[editingProductIndex]?.image_url" class="mt-2">
                                            <img :src="'../' + products[editingProductIndex].image_url" alt="Current product image" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                            <small class="d-block text-muted">Current image</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-success me-2">
                                        <i class="fas fa-check me-2"></i>{{ editingProductIndex !== null ? 'Update' : 'Add' }}
                                    </button>
                                    <button type="button" class="btn btn-secondary" @click="cancelProductEdit">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div v-for="(product, index) in products" :key="product.product_id || index" class="product-card mb-3">
                            <div class="d-flex gap-3">
                                <div v-if="product.image_url" class="product-image-container" style="flex-shrink: 0;">
                                    <img :src="'../' + product.image_url" alt="Product image" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="mb-0">{{ product.name }}</h5>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary" @click="editProduct(index)" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @click="removeProduct(index)" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-muted mb-0">{{ product.description }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Companies Tab -->
                    <div v-if="activeTab === 'interests'">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="mb-0"><i class="fas fa-heart me-2 text-danger"></i>Saved Companies</h2>
                            <button class="btn btn-success" @click="loadInterests">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                        </div>

                        <div v-if="loadingInterests" class="text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading your saved companies...</p>
                        </div>

                        <div v-else-if="savedBusinesses.length === 0" class="text-center py-5">
                            <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No companies saved yet</h4>
                            <p class="text-muted">Start exploring the directory and save companies you're interested in!</p>
                            <a href="directory.html" class="btn btn-success mt-3">
                                <i class="fas fa-search me-2"></i>Browse Directory
                            </a>
                        </div>

                        <div v-else class="row g-4">
                            <div v-for="business in savedBusinesses" :key="business.id" class="col-md-6 col-lg-4">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h5 class="card-title mb-0">{{ business.name }}</h5>
                                            <button 
                                                class="btn btn-sm btn-outline-danger" 
                                                @click="removeFromInterests(business.id)"
                                                title="Remove from saved companies"
                                            >
                                                <i class="fas fa-heart-broken"></i>
                                            </button>
                                        </div>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-tag me-1"></i>{{ business.category }}
                                        </p>
                                        <p class="card-text small text-muted mb-2" style="display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                            {{ business.description }}
                                        </p>
                                        <p class="text-muted small mb-3">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ business.location }}
                                        </p>
                                        <div class="d-flex gap-2">
                                            <a 
                                                :href="`business_profile.html?id=${business.id}`" 
                                                class="btn btn-sm btn-outline-success flex-fill"
                                            >
                                                <i class="fas fa-eye me-1"></i>View Profile
                                            </a>
                                            <a 
                                                :href="`messages_business.html?business_id=${business.id}`" 
                                                class="btn btn-sm btn-outline-primary"
                                                title="Send Message"
                                            >
                                                <i class="fas fa-envelope"></i>
                                            </a>
                                        </div>
                                        <small class="text-muted d-block mt-2">
                                            <i class="fas fa-clock me-1"></i>Saved {{ formatDate(business.savedDate) }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        
        window.googleMapsReady = (async function() {
            let apiKey = null;
            try {
                const response = await fetch('api/config.php');
                if (response.ok) {
                    const config = await response.json();
                    if (config.googleMapsApiKey) {
                        apiKey = config.googleMapsApiKey;
                        console.log('Loaded Google Maps API key from config.php');
                    }
                }
            } catch (error) {
                console.warn('Failed to load API key from config.php:', error);
            }
            if (!apiKey && GOOGLE_MAPS_API_KEY_FALLBACK) {
                apiKey = GOOGLE_MAPS_API_KEY_FALLBACK;
                console.log('Using fallback Google Maps API key');
            }
            
            if (!apiKey) {
                console.error('Google Maps API key not found');
                console.error('Please either:');
                console.error('1. Set GOOGLE_MAPS_API_KEY in main/.env file, OR');
                console.error('2. Set GOOGLE_MAPS_API_KEY_FALLBACK in partner_dashboard.html');
                return false;
            }
            
            (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
                        key: apiKey,
                        v: "weekly",
                        libraries: ["places"]
                    });
            
            console.log('Google Maps API script loading initiated');
            return true;
        })();
    </script>
    <script type="module">
        import { authMixin } from './js/auth-mixin.js';
        const { createApp } = Vue;

        createApp({
            mixins: [authMixin],
            data() {
                return {
                    businessId: null,
                    businessName: '', 
                    activeTab: 'overview',
                    profileUpdateMessage: '',
                    stats: { certifications: 0 },
                    profile: { 
                        name: '', 
                        category: '', 
                        description: '', 
                        phone: '', 
                        email: '', 
                        website: '', 
                        address: '',
                        location: '',
                        lat: null,
                        lng: null
                    },
                    previousAddress: '',
                    certifications: [],
                    showAddCert: false,
                    newCert: { name: '', code: '', issued: '', expiry: '' },
                    ecoPractices: [],
                    showAddPractice: false,
                    newPractice: { title: '', description: '' },
                    products: [],
                    showAddProduct: false,
                    newProduct: { name: '', description: '', image: null, imagePreview: null, removeImage: false },
                    editingProductIndex: null,
                    showCSVImport: false,
                    importedProducts: [],
                    savingProducts: false,
                    certValidationErrors: { issued: '', expiry: '' },
                    savedBusinesses: [],
                    loadingInterests: false,
                    passwordData: {
                        currentPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    },
                    passwordMessage: '',
                    passwordMessageType: ''
                }
            },
            computed: {
                maxIssueDate() {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                minExpiryDate() {
                    if (this.newCert.issued) {
                      
                        const issueDate = new Date(this.newCert.issued);
                        issueDate.setDate(issueDate.getDate() + 1); 
                        const year = issueDate.getFullYear();
                        const month = String(issueDate.getMonth() + 1).padStart(2, '0');
                        const day = String(issueDate.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                    return this.maxIssueDate;
                }
            },
            watch: {
                isLoggedIn(newVal) {
                    if (!this.authInitialized) {
                        return;
                    }
                    
                    if (newVal && this.userType === 'business') {
                        if (this.userName && !this.businessName) {
                            this.businessName = this.userName;
                        }
                        if (this.businessId) {
                    this.loadBusinessData();
                        } else {
                            setTimeout(() => this.loadBusinessData(), 500);
                        }
                    } else if (!newVal) {
                        window.location.href = 'login_business.html';
                    }
                },
                userName(newVal) {
                    if (newVal && !this.businessName) {
                        this.businessName = newVal;
                    }
                },
                'newCert.issued'() {
                    this.validateIssueDate();
                    if (this.newCert.expiry && this.newCert.issued) {
                        const issueDate = new Date(this.newCert.issued);
                        const expiryDate = new Date(this.newCert.expiry);
                        if (expiryDate <= issueDate) {
                            this.certValidationErrors.expiry = 'Expiry date must be after the issue date.';
                        } else {
                            this.certValidationErrors.expiry = '';
                        }
                    }
                },
                activeTab(newVal) {
                    if (newVal === 'interests' && this.isLoggedIn) {
                        this.loadInterests();
                    }
                },
                'newCert.expiry'() {
                    if (this.certValidationErrors.expiry && this.newCert.issued) {
                        const issueDate = new Date(this.newCert.issued);
                        const expiryDate = new Date(this.newCert.expiry);
                        if (expiryDate > issueDate) {
                            this.certValidationErrors.expiry = '';
                        }
                    }
                },
                authInitialized(newVal) {
                    if (newVal) {
                        if (this.isLoggedIn && this.userType === 'business') {
                            if (this.userName && !this.businessName) {
                                this.businessName = this.userName;
                            }
                            if (this.businessId) {
                                this.loadBusinessData();
                            } else {
                                setTimeout(() => this.loadBusinessData(), 500);
                            }
                        } else if (!this.isLoggedIn) {
                            console.log('Auth initialized, user not logged in, redirecting...');
                            window.location.href = 'login_business.html';
                        }
                    }
                }
            },
            async mounted() {
                if (this.userName && !this.businessName) {
                    this.businessName = this.userName;
                }
                
                const hash = window.location.hash.substring(1).toLowerCase();
                const switchToTab = sessionStorage.getItem('switchToTab');
                
                if (hash === 'interests' || switchToTab === 'interests') {
                    this.activeTab = 'interests';
                    sessionStorage.removeItem('switchToTab');
                    if (this.isLoggedIn) {
                        this.$nextTick(() => {
                            this.loadInterests();
                        });
                    }
                }
                
                setTimeout(() => {
                    this.initAddressAutocomplete();
                }, 1500); 
                const addressInputEl = document.getElementById('address-input');
                if (addressInputEl) {
                    const originalAddress = this.profile.address || '';
                    addressInputEl.addEventListener('input', () => {
                        const currentAddress = addressInputEl.value;
                        if (currentAddress !== originalAddress && currentAddress !== this.previousAddress) {
                            console.log('Address manually changed, clearing old coordinates');
                            this.profile.lat = null;
                            this.profile.lng = null;
                            const latInput = document.getElementById('address-lat');
                            const lngInput = document.getElementById('address-lng');
                            if (latInput) latInput.value = '';
                            if (lngInput) lngInput.value = '';
                        }
                    });
                }
                let attempts = 0;
                const maxAttempts = 25;
                const checkAuth = setInterval(() => {
                    attempts++;
                    
                    if (this.authInitialized) {
                        clearInterval(checkAuth);
                        if (this.isLoggedIn && this.userType === 'business') {
                            if (this.userName && !this.businessName) {
                                this.businessName = this.userName;
                            }
                            if (this.businessId) {
                                this.loadBusinessData();
                            } else {
                                setTimeout(() => this.loadBusinessData(), 500);
                            }
                        } else if (!this.isLoggedIn) {
                            console.log('User not logged in after auth initialization, redirecting...');
                            window.location.href = 'login_business.html';
                        }
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkAuth);
                        if (!this.isLoggedIn) {
                            console.log('Auth not initialized after max attempts, redirecting...');
                            window.location.href = 'login_business.html';
                        }
                    }
                }, 200);
                
            },
            beforeDestroy() {
            },
            methods: {
                async initAddressAutocomplete() {
                    try {
                        if (window.googleMapsReady) {
                            await window.googleMapsReady;
                        }
                        
                        let attempts = 0;
                        const maxAttempts = 100; 
                        while (attempts < maxAttempts) {
                            if (window.google && window.google.maps && window.google.maps.importLibrary) {
                                break;
                            }
                            await new Promise(resolve => setTimeout(resolve, 100));
                            attempts++;
                        }
                        
                        if (!window.google || !window.google.maps) {
                            console.warn('Google Maps API not loaded');
                            return;
                        }
                        
                        if (!window.google.maps.places) {
                            try {
                                const { Autocomplete } = await google.maps.importLibrary("places");
                                console.log('Places library loaded');
                            } catch (error) {
                                console.error('Failed to load Places library:', error);
                                return;
                            }
                        }
                        
                        if (!window.google.maps.places) {
                            console.warn('Google Maps Places API not available');
                            return;
                        }
                        
                        const addressInput = document.getElementById('address-input');
                        if (!addressInput) {
                            return;
                        }
                        
                        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                            componentRestrictions: { country: 'sg' }, // Restrict to Singapore
                            fields: ['formatted_address', 'geometry', 'name']
                        });
                        
                        autocomplete.addListener('place_changed', () => {
                            const place = autocomplete.getPlace();
                            
                            if (!place.geometry || !place.geometry.location) {
                                console.warn('No geometry found for place');
                                return;
                            }
                            
                            this.profile.address = place.formatted_address || addressInput.value;
                            const location = place.geometry.location;
                            let lat = typeof location.lat === 'function' ? location.lat() : location.lat;
                            let lng = typeof location.lng === 'function' ? location.lng() : location.lng;
                            lat = parseFloat(lat.toFixed(6));
                            lng = parseFloat(lng.toFixed(6));
                            
                            this.profile.lat = lat;
                            this.profile.lng = lng;
                            
                            const latInput = document.getElementById('address-lat');
                            const lngInput = document.getElementById('address-lng');
                            if (latInput) latInput.value = lat;
                            if (lngInput) lngInput.value = lng;
                            
                            console.log('Address geocoded:', {
                                address: this.profile.address,
                                lat: lat,
                                lng: lng
                            });
                        });
                    } catch (error) {
                        console.error('Error initializing address autocomplete:', error);
                    }
                },
                
                async geocodeAddress(address) {
                    if (!window.google || !window.google.maps) {
                        console.warn('Google Maps not available for geocoding');
                        return null;
                    }
                    
                    if (!window.google.maps.Geocoder) {
                        console.warn('Google Maps Geocoder not available');
                        return null;
                    }
                    
                    try {
                        const geocoder = new google.maps.Geocoder();
                        
                        return new Promise((resolve) => {
                            geocoder.geocode({ address: address }, (results, status) => {
                                if (status === 'OK' && results && results[0]) {
                                    const location = results[0].geometry.location;
                                    let lat = typeof location.lat === 'function' ? location.lat() : location.lat;
                                    let lng = typeof location.lng === 'function' ? location.lng() : location.lng;
                                    lat = parseFloat(lat.toFixed(6));
                                    lng = parseFloat(lng.toFixed(6));
                                    
                                    console.log('Geocoding successful:', { address, lat, lng });
                                    resolve({ lat, lng });
                                } else {
                                    console.warn('Geocoding failed:', status, results);
                                    resolve(null);
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Error geocoding address:', error);
                        return null;
                    }
                },
                
                async viewPublicProfile(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    let businessIdToUse = this.businessId;
                    
                    if (!businessIdToUse || isNaN(businessIdToUse) || typeof businessIdToUse === 'string') {
                        console.log('Business ID not available or invalid, reloading data...');
                        await this.refreshSession();
                        await this.loadBusinessData();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        businessIdToUse = this.businessId;
                        
                        if (!businessIdToUse || isNaN(businessIdToUse)) {
                            alert('Unable to load business ID. Please refresh the page.');
                            return;
                        }
                    }
                    
                    businessIdToUse = parseInt(businessIdToUse);
                    
                    if (isNaN(businessIdToUse) || businessIdToUse <= 0) {
                        alert('Invalid business ID. Please refresh the page.');
                        return;
                    }
                    
                    console.log('Navigating to business_profile.html?id=' + businessIdToUse);
                    window.location.href = 'business_profile.html?id=' + businessIdToUse;
                },
               
                async refreshSession() {
                    try {
                        const response = await fetch('api/auth.php?action=check', {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                        if (!response.ok) {
                            console.error('Failed to check session:', response.status);
                            if (response.status === 401) {
                                window.location.href = 'login_business.html';
                                return false;
                            }
                            return false;
                        }
                        
                        const result = await response.json();
                        if (!result.loggedIn || result.userType !== 'business') {
                            console.error('Session invalid or not business user');
                            window.location.href = 'login_business.html';
                            return false;
                        }
                        
                        return true;
                    } catch (error) {
                        console.error('Error checking session:', error);
                        return false;
                    }
                },

                async loadBusinessData() {
                    console.log('loadBusinessData() called');
                  
                    console.log('Verifying session...');
                    const sessionRefreshed = await this.refreshSession();
                    if (!sessionRefreshed) {
                        console.error('Failed to verify session');
                        alert('Session expired. Please log in again.');
                        window.location.href = 'login_business.html';
                        return;
                    }
                    console.log('Session verified successfully');
                    
                    let sessionVerified = false;
                    let retries = 0;
                    const maxRetries = 3;
                    
                    while (!sessionVerified && retries < maxRetries) {
                        try {
                            console.log(`Verifying session (attempt ${retries + 1}/${maxRetries})...`);
                            const sessionResp = await fetch('api/bridge.php?action=get_user', {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                            if (sessionResp.ok) {
                                const sessionData = await sessionResp.json();
                                console.log('Session data:', sessionData);
                                
                                if (sessionData.success && sessionData.user?.userType === 'business') {
                                   
                                    if (sessionData.business?.businessId) {
                                        this.businessId = sessionData.business.businessId;
                                        console.log('Set businessId from session:', this.businessId);
                                    }
                                    if (sessionData.user?.userId) {
                                        this.userId = sessionData.user.userId;
                                        console.log('Set userId from session:', this.userId);
                                    }
                                    sessionVerified = true;
                                    console.log('Session verified successfully - user is a business');
                                } else {
                                    console.error('Session data invalid - user is not a business:', sessionData);
                                    console.error('User type:', sessionData.user?.userType);
                                    if (sessionData.success && sessionData.user?.userType !== 'business') {
                                        alert('You must be logged in as a business to access this page.');
                            window.location.href = 'login_business.html';
                            return;
                        }
                                    retries++;
                                    if (retries < maxRetries) {
                                        
                                        await new Promise(resolve => setTimeout(resolve, 500));
                                        await this.refreshSession();
                                    }
                                }
                            } else {
                                console.error('Session verification failed. Status:', sessionResp.status);
                                if (sessionResp.status === 401) {
                                    retries++;
                                    if (retries < maxRetries) {
                                        await this.refreshSession();
                                        await new Promise(resolve => setTimeout(resolve, 500));
                                    }
                                } else {
                                    retries = maxRetries;
                                }
                            }
                        } catch (e) {
                            console.error('Error verifying session:', e);
                            retries++;
                            if (retries < maxRetries) {
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }
                    }
                    
                    if (!sessionVerified) {
                        console.error('Failed to verify session after retries');
                        alert('Unable to verify session. Please log in again.');
                        window.location.href = 'login_business.html';
                        return;
                    }

                    try {
                        console.log('Fetching business profile data...');
                        const response = await fetch('api/data.php?action=business_profile', {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                console.error('401 Unauthorized - Session not working');
                                await this.refreshSession();
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                const retryResponse = await fetch('api/data.php?action=business_profile', {
                                    method: 'GET',
                                    credentials: 'include'
                                });
                                
                                if (!retryResponse.ok) {
                                    console.error('401 Unauthorized - Session may have expired');
                                    alert('Session expired. Please log in again.');
                                window.location.href = 'login_business.html';
                                    return;
                                }
                                
                                const retryData = await retryResponse.json();
                                if (retryData.success) {
                                    this.processBusinessData(retryData);
                                    return;
                                }
                            }
                            
                            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                            console.error('Failed to load business data:', errorData);
                            alert('Failed to load business data: ' + (errorData.error || 'Unknown error'));
                            return;
                        }

                        const data = await response.json();
                        console.log('Business data loaded:', data);
                        this.processBusinessData(data);
                    } catch (e) {
                        console.error('Error loading business data:', e);
                        alert('Failed to load business data. Please try again.');
                    }
                },
                
                processBusinessData(data) {
                    if (!data.success) {
                        console.error('Business data not successful:', data);
                        return;
                    }
                    
                    let newBusinessId = null;
                    
                    if (data.businessId) {
                        newBusinessId = parseInt(data.businessId);
                    } else if (data.business?.id) {
                        newBusinessId = parseInt(data.business.id);
                    }
                    
                    if (newBusinessId && !isNaN(newBusinessId) && newBusinessId > 0) {
                        this.businessId = newBusinessId;
                        console.log('Set businessId (MySQL ID):', this.businessId);
                    } else {
                        console.error('WARNING: Invalid businessId! Data:', data);
                        console.error('businessId value:', newBusinessId, 'Type:', typeof newBusinessId);
                    }
                    
                    this.businessName = data.business.business_name || this.userName || this.businessName || 'Business';
                    
                            this.profile = {
                        name: data.business.business_name || '',
                                category: data.business.category || '',
                                description: data.business.description || '',
                                phone: data.business.phone || '',
                                email: data.business.email || '',
                                website: data.business.website || '',
                        address: data.business.address || '',
                        location: data.locations?.[0]?.address || '',
                        lat: data.business.lat || null,
                        lng: data.business.lng || null
                            };

                            this.certifications = data.certifications || [];
                            this.ecoPractices = data.practices || [];
                            this.products = data.products || [];

                            this.stats = {
                                certifications: data.certifications?.length || 0
                            };
                            this.previousAddress = this.profile.address || '';
                            console.log('Loaded business data, previousAddress set to:', this.previousAddress);
                },

                filterPhoneNumber(event) {
                    event.target.value = event.target.value.replace(/\D/g, '');
                    this.profile.phone = event.target.value;
                },
                

                async updateProfile() {
                    const hasPasswordChange = this.passwordData.currentPassword || 
                                            this.passwordData.newPassword || 
                                            this.passwordData.confirmPassword;
                    
                    if (hasPasswordChange) {
                        if (!this.passwordData.currentPassword || !this.passwordData.newPassword || !this.passwordData.confirmPassword) {
                            this.passwordMessage = 'All password fields are required to change password';
                            this.passwordMessageType = 'error';
                            return;
                        }

                        if (this.passwordData.newPassword !== this.passwordData.confirmPassword) {
                            this.passwordMessage = 'New password and confirm password do not match';
                            this.passwordMessageType = 'error';
                            return;
                        }

                        if (this.passwordData.newPassword.length < 6) {
                            this.passwordMessage = 'New password must be at least 6 characters long';
                            this.passwordMessageType = 'error';
                            return;
                        }

                        try {
                            const passwordResponse = await fetch('api/auth.php?action=change_password', {
                                method: 'POST',
                                credentials: 'include',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    currentPassword: this.passwordData.currentPassword,
                                    newPassword: this.passwordData.newPassword,
                                    confirmPassword: this.passwordData.confirmPassword
                                })
                            });

                            const passwordData = await passwordResponse.json();
                            
                            if (!passwordData.success) {
                                this.passwordMessage = passwordData.error || 'Failed to change password';
                                this.passwordMessageType = 'error';
                                return;
                            }
                            
                            this.passwordData = {
                                currentPassword: '',
                                newPassword: '',
                                confirmPassword: ''
                            };
                        } catch (error) {
                            console.error('Error changing password:', error);
                            this.passwordMessage = 'Network error: Please try again';
                            this.passwordMessageType = 'error';
                            return;
                        }
                    }

                    try {
                        await this.refreshSession();
                        let lat = this.profile.lat;
                        let lng = this.profile.lng;
                        if ((!lat || lat === null) && document.getElementById('address-lat')?.value) {
                            lat = parseFloat(document.getElementById('address-lat').value);
                        }
                        if ((!lng || lng === null) && document.getElementById('address-lng')?.value) {
                            lng = parseFloat(document.getElementById('address-lng').value);
                        }
                        
                        if (lat && typeof lat === 'string') {
                            lat = parseFloat(lat);
                        }
                        if (lng && typeof lng === 'string') {
                            lng = parseFloat(lng);
                        }
                        if (this.profile.address && this.profile.address.trim()) {
                            console.log('=== Geocoding Check ===');
                            console.log('Current address:', this.profile.address);
                            console.log('Previous address:', this.previousAddress);
                            console.log('Current lat before geocoding:', lat);
                            console.log('Current lng before geocoding:', lng);
                            console.log('Address changed?', this.profile.address !== this.previousAddress);
                            
                            const shouldGeocode = this.profile.address !== this.previousAddress || 
                                                  !lat || !lng || 
                                                  isNaN(lat) || isNaN(lng);
                            
                            if (shouldGeocode) {
                                console.log('Geocoding address:', this.profile.address);
                                lat = null;
                                lng = null;
                                
                                const geocoded = await this.geocodeAddress(this.profile.address);
                                if (geocoded) {
                                    lat = geocoded.lat;
                                    lng = geocoded.lng;
                                    console.log('✅ Geocoding successful!', { lat, lng });
                                    
                                    this.profile.lat = lat;
                                    this.profile.lng = lng;
                                    const latInput = document.getElementById('address-lat');
                                    const lngInput = document.getElementById('address-lng');
                                    if (latInput) latInput.value = lat;
                                    if (lngInput) lngInput.value = lng;
                                } else {
                                    console.error('❌ Geocoding failed');
                                }
                            } else {
                                console.log('Using existing coordinates (address unchanged)');
                            }
                        }
                        
                        const profileData = {
                            ...this.profile,
                            lat: (lat && !isNaN(lat)) ? lat : null,
                            lng: (lng && !isNaN(lng)) ? lng : null
                        };
                        
                        console.log('Updating profile with data:', {
                            address: profileData.address,
                            lat: profileData.lat,
                            lng: profileData.lng
                        });
                        
                        const response = await fetch('api/data.php?action=update_business_profile', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(profileData)
                        });

                        const data = await response.json();
                        if (data.success) {
                            if (hasPasswordChange) {
                                this.profileUpdateMessage = 'Profile and password updated successfully!';
                                this.passwordMessage = 'Password changed successfully';
                                this.passwordMessageType = 'success';
                            } else {
                                this.profileUpdateMessage = 'Profile updated successfully!';
                            }
                            this.businessName = this.profile.name; // Update display name
                            setTimeout(() => { 
                                this.profileUpdateMessage = '';
                                if (hasPasswordChange) {
                                    this.passwordMessage = '';
                                    this.passwordMessageType = '';
                                }
                            }, 3000);
                            await this.loadBusinessData();
                        } else {
                            this.profileUpdateMessage = 'Error: ' + (data.error || 'Failed to update profile');
                            setTimeout(() => { this.profileUpdateMessage = ''; }, 5000);
                        }
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        this.profileUpdateMessage = 'Network error: Please try again';
                        setTimeout(() => { this.profileUpdateMessage = ''; }, 5000);
                    }
                },

                validateIssueDate() {
                    if (!this.newCert.issued) {
                        this.certValidationErrors.issued = '';
                        return;
                    }
                    
                    const issueDate = new Date(this.newCert.issued);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 
                    if (isNaN(issueDate.getTime())) {
                        this.certValidationErrors.issued = 'Please enter a valid date.';
                        return;
                    }
                    
                    if (issueDate > today) {
                        this.certValidationErrors.issued = 'Issue date cannot be in the future.';
                        this.$nextTick(() => {
                            this.newCert.issued = this.maxIssueDate;
                        });
                        return;
                    }
                    
                    const hundredYearsAgo = new Date();
                    hundredYearsAgo.setFullYear(today.getFullYear() - 100);
                    if (issueDate < hundredYearsAgo) {
                        this.certValidationErrors.issued = 'Issue date cannot be more than 100 years ago.';
                        return;
                    }
                    this.certValidationErrors.issued = '';
                },
                async addCertification() {
                    this.certValidationErrors = { issued: '', expiry: '' };
                    
                    if (!this.newCert.name || this.newCert.name.trim() === '') {
                        alert('Please select a certification from the dropdown list.');
                        return;
                    }
                    
                    if (!this.newCert.code || this.newCert.code.trim() === '') {
                        alert('Please enter a certificate number.');
                        return;
                    }
                    
                    if (!this.newCert.issued) {
                        alert('Please select an issue date.');
                        return;
                    }
                    this.validateIssueDate();
                    if (this.certValidationErrors.issued) {
                        alert('Issue date validation failed: ' + this.certValidationErrors.issued);
                        return;
                    }
                    
                    const issueDate = new Date(this.newCert.issued);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 
                    
                    if (issueDate > today) {
                        this.certValidationErrors.issued = 'Issue date cannot be in the future.';
                        alert('Issue date cannot be in the future. Please select a valid date.');
                        return;
                    }
                    if (!this.newCert.expiry) {
                        alert('Please select an expiry date.');
                        return;
                    }
                    
                    const expiryDate = new Date(this.newCert.expiry);
                    
                    if (expiryDate <= issueDate) {
                        this.certValidationErrors.expiry = 'Expiry date must be after the issue date.';
                        alert('Expiry date must be after the issue date. Please select a valid date.');
                        return;
                    }
                    
                    if (expiryDate < today) {
                        if (!confirm('Warning: This certification has already expired. Do you want to add it anyway?')) {
                            return;
                        }
                    }
                    
                    try {
                        await this.refreshSession();
                        
                        const response = await fetch('api/data.php?action=add_certification', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newCert)
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.certifications.push({ 
                                cert_id: data.certId,
                                name: this.newCert.name,
                                code: this.newCert.code,
                                issued: this.newCert.issued,
                                expiry: this.newCert.expiry
                            });
                            this.newCert = { name: '', code: '', issued: '', expiry: '' };
                            this.certValidationErrors = { issued: '', expiry: '' };
                            this.showAddCert = false;
                            alert('Certification added successfully!');
                            this.loadBusinessData();
                        } else {
                            alert('Error adding certification: ' + (data.error || 'Unknown error'));
                            console.error('Failed to add certification:', data);
                        }
                    } catch (error) {
                        console.error('Error adding certification:', error);
                        alert('Network error: Please try again.');
                    }
                },

                async removeCertification(index) {
                    if (!confirm('Are you sure?')) return;
                    const certId = this.certifications[index].cert_id;
                    try {
                        const response = await fetch('api/data.php?action=remove_certification', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ certId })
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.certifications.splice(index, 1);
                        }
                    } catch (error) {
                        console.error('Error removing certification:', error);
                    }
                },

                async addPractice() {
                    try {
                        await this.refreshSession();
                        
                        const response = await fetch('api/data.php?action=add_practice', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newPractice)
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.ecoPractices.push({ 
                                practice_id: data.practiceId,
                                title: this.newPractice.title,
                                description: this.newPractice.description
                            });
                            this.newPractice = { title: '', description: '' };
                            this.showAddPractice = false;
                            alert('Eco practice added successfully!');
                            this.loadBusinessData();
                        } else {
                            alert('Error adding practice: ' + (data.error || 'Unknown error'));
                            console.error('Failed to add practice:', data);
                        }
                    } catch (error) {
                        console.error('Error adding practice:', error);
                        alert('Network error: Please try again.');
                    }
                },

                async removePractice(index) {
                    if (!confirm('Are you sure?')) return;
                    const practiceId = this.ecoPractices[index].practice_id;
                    try {
                        const response = await fetch('api/data.php?action=remove_practice', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ practiceId })
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.ecoPractices.splice(index, 1);
                        }
                    } catch (error) {
                        console.error('Error removing practice:', error);
                    }
                },

                handleProductImageChange(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        this.newProduct.image = null;
                        this.newProduct.imagePreview = null;
                        return;
                    }
                    
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        alert('Invalid file type. Please select an image (JPG, PNG, GIF, or WEBP)');
                        event.target.value = '';
                        this.newProduct.image = null;
                        this.newProduct.imagePreview = null;
                        return;
                    }
                    
                    const maxSize = 5 * 1024 * 1024;
                    if (file.size > maxSize) {
                        alert('Image size too large. Maximum size is 5MB');
                        event.target.value = '';
                        this.newProduct.image = null;
                        this.newProduct.imagePreview = null;
                        return;
                    }
                    
                    this.newProduct.image = file;
                    this.newProduct.removeImage = false;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.newProduct.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                removeProductImage() {
                    this.newProduct.image = null;
                    this.newProduct.imagePreview = null;
                    this.newProduct.removeImage = true;
                    if (this.$refs.productImageInput) {
                        this.$refs.productImageInput.value = '';
                    }
                },
                editProduct(index) {
                    const product = this.products[index];
                    this.editingProductIndex = index;
                    this.newProduct = {
                        name: product.name || '',
                        description: product.description || '',
                        image: null,
                        imagePreview: null,
                        removeImage: false
                    };
                    this.showAddProduct = true;
                },
                cancelProductEdit() {
                    this.editingProductIndex = null;
                    this.newProduct = { name: '', description: '', image: null, imagePreview: null, removeImage: false };
                    this.showAddProduct = false;
                    if (this.$refs.productImageInput) {
                        this.$refs.productImageInput.value = '';
                    }
                },
                async addProduct() {
                    try {
                        await this.refreshSession();
                        
                        if (!this.newProduct.name || !this.newProduct.name.trim()) {
                            alert('Please enter a product/service name.');
                            return;
                        }
                        
                        if (!this.newProduct.description || !this.newProduct.description.trim()) {
                            alert('Please enter a description.');
                            return;
                        }
                        
                        const formData = new FormData();
                        formData.append('action', 'add_product');
                        formData.append('name', this.newProduct.name);
                        formData.append('description', this.newProduct.description);
                        formData.append('available', '1');
                        
                        if (this.newProduct.image) {
                            formData.append('image', this.newProduct.image);
                        }
                        
                        const response = await fetch('api/data.php', {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        const data = await response.json();
                        console.log('Add product response:', data);
                        if (data.success) {
                            this.products.push({ 
                                product_id: data.productId,
                                name: this.newProduct.name,
                                description: this.newProduct.description,
                                image_url: data.image_url || null,
                                available: true
                            });
                            this.cancelProductEdit();
                            alert('Product/Service added successfully!');
                            this.loadBusinessData();
                        } else {
                            alert('Error adding product: ' + (data.error || 'Unknown error'));
                            console.error('Failed to add product:', data);
                        }
                    } catch (error) {
                        console.error('Error adding product:', error);
                        alert('Network error: Please try again.');
                    }
                },
                async updateProduct() {
                    if (this.editingProductIndex === null) return;
                    
                    try {
                        await this.refreshSession();
                        
                        const product = this.products[this.editingProductIndex];
                        const productId = product.product_id;
                        
                        if (!this.newProduct.name || !this.newProduct.name.trim()) {
                            alert('Please enter a product/service name.');
                            return;
                        }
                        
                        if (!this.newProduct.description || !this.newProduct.description.trim()) {
                            alert('Please enter a description.');
                            return;
                        }
                        
                        const formData = new FormData();
                        formData.append('action', 'update_product');
                        formData.append('productId', productId);
                        formData.append('name', this.newProduct.name);
                        formData.append('description', this.newProduct.description);
                        
                        if (this.newProduct.image) {
                            formData.append('image', this.newProduct.image);
                        }
                        
                        if (this.newProduct.removeImage) {
                            formData.append('remove_image', '1');
                        }
                        
                        const response = await fetch('api/data.php', {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.products[this.editingProductIndex] = {
                                ...this.products[this.editingProductIndex],
                                name: this.newProduct.name,
                                description: this.newProduct.description,
                                image_url: data.image_url !== undefined ? data.image_url : this.products[this.editingProductIndex].image_url
                            };
                            this.cancelProductEdit();
                            alert('Product/Service updated successfully!');
                            this.loadBusinessData();
                        } else {
                            alert('Error updating product: ' + (data.error || 'Unknown error'));
                            console.error('Failed to update product:', data);
                        }
                    } catch (error) {
                        console.error('Error updating product:', error);
                        alert('Network error: Please try again.');
                    }
                },

                handleCSVFileSelect(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    if (!file.name.endsWith('.csv')) {
                        alert('Please select a CSV file');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const csv = e.target.result;
                            const lines = csv.split('\n').filter(line => line.trim());
                            
                            if (lines.length < 2) {
                                alert('CSV file must have at least a header row and one data row');
                                return;
                            }
                            
                           
                            const products = [];
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                               
                                const fields = this.parseCSVLine(line);
                                
                                if (fields.length >= 2) {
                                   
                                    products.push({
                                        name: fields[0].trim() || '',
                                        description: fields[1].trim() || '',
                                        image: null,
                                        imagePreview: null
                                    });
                                } else if (fields.length >= 1 && fields[0].trim()) {
                                    
                                    products.push({
                                        name: fields[0].trim() || '',
                                        description: '',
                                        image: null,
                                        imagePreview: null
                                    });
                                }
                            }
                            
                            if (products.length === 0) {
                                alert('No valid products found in CSV file');
                                return;
                            }
                            
                            this.importedProducts = products;
                            alert(`Successfully parsed ${products.length} products from CSV`);
                        } catch (error) {
                            console.error('Error parsing CSV:', error);
                            alert('Error parsing CSV file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                },
                
                parseCSVLine(line) {
                    const fields = [];
                    let currentField = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                currentField += '"';
                                i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            fields.push(currentField);
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    fields.push(currentField); 
                    return fields;
                },
                
                handleBulkImageUpload(event) {
                    const files = Array.from(event.target.files);
                    if (files.length === 0) return;
                    
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                    const maxSize = 5 * 1024 * 1024; 
                    
                    for (let i = 0; i < files.length && i < this.importedProducts.length; i++) {
                        const file = files[i];
                        
                        if (!allowedTypes.includes(file.type)) {
                            alert(`File ${file.name} is not a valid image type. Skipping.`);
                            continue;
                        }
                        
                        if (file.size > maxSize) {
                            alert(`File ${file.name} is too large (max 5MB). Skipping.`);
                            continue;
                        }
                        
                        this.importedProducts[i].image = file;
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.importedProducts[i].imagePreview = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    if (files.length > this.importedProducts.length) {
                        alert(`Only ${this.importedProducts.length} image(s) were assigned. ${files.length - this.importedProducts.length} extra image(s) were ignored.`);
                    }
                    
                    event.target.value = '';
                },
                
                handleProductImageUpload(index, event) {
                    const file = event.target.files[0];
                    if (!file) {
                        this.importedProducts[index].image = null;
                        this.importedProducts[index].imagePreview = null;
                        return;
                    }
                    
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        alert('Invalid file type. Please select an image (JPG, PNG, GIF, or WEBP)');
                        event.target.value = '';
                        return;
                    }
                    
                    const maxSize = 5 * 1024 * 1024;
                    if (file.size > maxSize) {
                        alert('Image size too large. Maximum size is 5MB');
                        event.target.value = '';
                        return;
                    }
                    
                    this.importedProducts[index].image = file;
                   
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.importedProducts[index].imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                
                removeProductImageFromImport(index) {
                    this.importedProducts[index].image = null;
                    this.importedProducts[index].imagePreview = null;
                    
                },
                
                removeImportedProduct(index) {
                    this.importedProducts.splice(index, 1);
                },
                
                cancelCSVImport() {
                    this.showCSVImport = false;
                    this.importedProducts = [];
                    if (this.$refs.csvFileInput) {
                        this.$refs.csvFileInput.value = '';
                    }
                    if (this.$refs.bulkImageInput) {
                        this.$refs.bulkImageInput.value = '';
                    }
                },
                
                async saveImportedProducts() {
                    if (this.importedProducts.length === 0) {
                        alert('No products to save');
                        return;
                    }
                    
                    const invalidProducts = this.importedProducts.filter(p => !p.name || !p.name.trim());
                    if (invalidProducts.length > 0) {
                        alert(`Please fill in Name for all products. ${invalidProducts.length} product(s) are missing required fields.`);
                        return;
                    }
                    
                    this.savingProducts = true;
                    
                    try {
                        await this.refreshSession();
                       
                        let successCount = 0;
                        let failCount = 0;
                        
                        for (const product of this.importedProducts) {
                            try {
                                const formData = new FormData();
                                formData.append('action', 'add_product');
                                formData.append('name', product.name);
                                formData.append('description', product.description || '');
                                formData.append('available', '1');
                                
                                if (product.image) {
                                    formData.append('image', product.image);
                                }
                                
                                const response = await fetch('api/data.php', {
                                    method: 'POST',
                                    credentials: 'include',
                                    body: formData
                                });
                                
                                const data = await response.json();
                                if (data.success) {
                                    successCount++;
                                } else {
                                    failCount++;
                                    console.error('Failed to save product:', product.name, data.error);
                                }
                            } catch (error) {
                                console.error('Error saving product:', error);
                                failCount++;
                            }
                        }
                        
                        if (successCount > 0) {
                            alert(`Successfully imported ${successCount} product(s)!${failCount > 0 ? ` ${failCount} failed.` : ''}`);
                            this.cancelCSVImport();
                            this.loadBusinessData(); 
                        } else {
                            alert('Failed to import products. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error saving imported products:', error);
                        alert('Error saving products: ' + error.message);
                    } finally {
                        this.savingProducts = false;
                    }
                },

                async removeProduct(index) {
                    if (!confirm('Are you sure?')) return;
                    const productId = this.products[index].product_id;
                    try {
                        const response = await fetch('api/data.php?action=remove_product', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ productId })
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.products.splice(index, 1);
                        }
                    } catch (error) {
                        console.error('Error removing product:', error);
                    }
                },

                async loadInterests() {
                    this.loadingInterests = true;
                    try {
                        const response = await fetch('api/data.php?action=get_saved_businesses', {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                this.savedBusinesses = data.savedCompanies || [];
                            } else {
                                console.error('Failed to load interests:', data.error);
                                this.savedBusinesses = [];
                            }
                        } else {
                            console.error('Failed to load interests:', response.statusText);
                            this.savedBusinesses = [];
                        }
                    } catch (error) {
                        console.error('Error loading interests:', error);
                        this.savedBusinesses = [];
                    } finally {
                        this.loadingInterests = false;
                    }
                },

                async removeFromInterests(businessId) {
                    if (!confirm('Remove this company from your saved companies?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch('api/data.php?action=remove_business', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ business_id: businessId })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            this.savedBusinesses = this.savedBusinesses.filter(b => b.id !== businessId);
                            alert('Company removed from your saved companies');
                        } else {
                            alert(data.error || 'Failed to remove company from saved companies');
                        }
                    } catch (error) {
                        console.error('Error removing from saved companies:', error);
                        alert('Error removing company from saved companies. Please try again.');
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return 'Unknown';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return dateString;
                        
                        const now = new Date();
                        const diffMs = now.getTime() - date.getTime();
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 0) {
                            return 'today';
                        } else if (diffDays === 1) {
                            return 'yesterday';
                        } else if (diffDays < 7) {
                            return `${diffDays} days ago`;
                        } else if (diffDays < 30) {
                            const weeks = Math.floor(diffDays / 7);
                            return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
                        } else if (diffDays < 365) {
                            const months = Math.floor(diffDays / 30);
                            return `${months} month${months > 1 ? 's' : ''} ago`;
                        } else {
                            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        }
                    } catch (error) {
                        return dateString;
                    }
                }

            }
        }).mount('#app');
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currentPage = window.location.pathname.split('/').pop() || 'partner_dashboard.html';
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                const linkHref = link.getAttribute('href');
                if (linkHref && (linkHref === currentPage || (currentPage === '' && linkHref === 'partner_dashboard.html'))) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>