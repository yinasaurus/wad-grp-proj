<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Green Business Directory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/user_account.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-leaf me-2"></i>Green Business Directory
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="directory.html">Directory</a></li>
                        <li class="nav-item"><a class="nav-link" href="forum.html">Community</a></li>
                        <li class="nav-item"><a class="nav-link active" href="about.html">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    </ul>
            
                    <div class="dropdown">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i>{{ userName }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item fw-bold" href="user_account.html">
                                <i class="fas fa-tachometer-alt me-2"></i>My Dashboard
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <li><a class="dropdown-item" href="#" @click.prevent="activeTab = 'interests'">
                                <i class="fas fa-heart me-2"></i>My Interests
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <li><a class="dropdown-item" href="register_business.html">
                                <i class="fas fa-plus me-2"></i>List Your Business
                            </a></li>
                            <li><a class="dropdown-item" href="#" @click.prevent="logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row g-4">
                <div class="col-lg-3">
                    <div class="sidebar-nav">
                        <h5 class="px-3 mb-3 text-secondary text-uppercase small fw-bold">My Account</h5>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'overview'}" href="#" @click.prevent="activeTab = 'overview'">
                                    <i class="fas fa-tachometer-alt me-2"></i>Overview
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'profile'}" href="#" @click.prevent="activeTab = 'profile'">
                                    <i class="fas fa-user-circle me-2"></i>Profile Details
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'interests'}" href="#" @click.prevent="activeTab = 'interests'">
                                    <i class="fas fa-bookmark me-2"></i>Saved Companies
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-9">
                    
                    <div v-if="activeTab === 'overview'">
                        <h2 class="mb-4">Welcome back, {{ userName }}!</h2>
                        
                        <div class="row g-4 mb-4">
                            <div class="col-lg-12">
                                <div class="offset-stat-widget">
                                    <h3 class="mb-0">{{ offsetStats.totalOffset }} kg COâ‚‚</h3>
                                    <p class="lead mb-0">Total Carbon Offset So Far</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="preferences-card text-center">
                                    <i class="fas fa-tree fa-3x text-success mb-2"></i>
                                    <h5>{{ offsetStats.treesEquivalent }} Trees</h5>
                                    <p class="text-muted small mb-0">Equivalent to planting</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="preferences-card text-center">
                                    <i class="fas fa-car-side fa-3x text-primary mb-2"></i>
                                    <h5>{{ offsetStats.milesNotDriven }} km</h5>
                                    <p class="text-muted small mb-0">Car Miles Not Driven</p>
                                </div>
                            </div>
                        </div>

                        <div class="preferences-card">
                            <h4 class="mb-3"><i class="fas fa-bookmark me-2 text-warning"></i>Your Saved Companies</h4>
                            <p class="text-muted">You have saved {{ savedCompanies.length }} companies that match your interests.</p>
                            <button class="btn btn-primary" @click="activeTab = 'interests'">
                                View Saved Companies
                            </button>
                        </div>
                    </div>

                    <div v-if="activeTab === 'profile'">
                        <div class="preferences-card">
                            <h4 class="mb-4"><i class="fas fa-user-circle me-2 text-primary"></i>Edit Profile Details</h4>
                            <form @submit.prevent="updateProfile">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Full Name</label>
                                        <input type="text" class="form-control" v-model="userProfile.name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Email Address</label>
                                        <input type="email" class="form-control" v-model="userProfile.email" disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Phone Number</label>
                                        <input type="tel" class="form-control" v-model="userProfile.phone">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Location / City</label>
                                        <input type="text" class="form-control" v-model="userProfile.location">
                                    </div>
                                </div>
                                <h6 class="mt-4 mb-3">Change Password</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="password" class="form-control" placeholder="Current Password">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="password" class="form-control" placeholder="New Password">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="password" class="form-control" placeholder="Confirm New Password">
                                    </div>
                                </div>
                                <div class="alert alert-success mt-3" v-if="profileMessage">
                                    <i class="fas fa-check-circle me-2"></i>{{ profileMessage }}
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg mt-4">
                                    <i class="fas fa-save me-2"></i>Save Profile Changes
                                </button>
                            </form>
                        </div>
                    </div>

                    <div v-if="activeTab === 'interests'">
                        <div class="preferences-card mb-3">
                            <h4 class="mb-3"><i class="fas fa-bookmark me-2 text-primary"></i>Saved Companies</h4>
                            <p class="text-muted">Companies you're interested in</p>
                        </div>

                        <div v-if="savedCompanies.length === 0" class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            You haven't saved any companies yet. Browse the directory to add companies to your interests!
                        </div>

                        <div v-for="company in savedCompanies" :key="company.id" class="company-card" style="cursor: pointer;" @click="viewBusiness(company.id)">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="mb-1">{{ company.name }}</h5>
                                    <span class="location-badge">
                                        <i class="fas fa-map-marker-alt me-1"></i>{{ company.location }}
                                    </span>
                                </div>
                                <button class="btn btn-sm btn-danger" @click.stop="removeCompany(company.id)">
                                    <i class="fas fa-trash me-1"></i>Remove
                                </button>
                            </div>
                            
                            <p class="text-muted mt-3 mb-2">{{ company.description }}</p>
                            
                            <div class="mt-3">
                                <strong class="small">Categories:</strong>
                                <div>
                                    <span v-for="category in company.categories" :key="category" class="category-badge">
                                        {{ category }}
                                    </span>
                                </div>
                            </div>

                            <div class="mt-2">
                                <strong class="small">Topics:</strong>
                                <div>
                                    <span v-for="topic in company.topics" :key="topic" class="category-badge" style="background: #3b82f6;">
                                        {{ topic }}
                                    </span>
                                </div>
                            </div>

                            <small class="text-muted d-block mt-3">Saved on: {{ formatDate(company.savedDate) }}</small>
                        </div>

                        <div class="preferences-card mt-4">
                            <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Interest Stats</h6>
                            <p><strong>{{ savedCompanies.length }}</strong> Companies Saved</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: window.location.hash.substring(1) || 'overview',
                    userName: 'John Doe',
                    profileMessage: '',
                    
                    offsetStats: {
                        totalOffset: 450,
                        treesEquivalent: 21,
                        milesNotDriven: 1125,
                    },
                    userProfile: {
                        name: 'John Doe',
                        email: 'john.doe@example.com',
                        phone: '+65 9123 4567',
                        location: 'Central Singapore'
                    },

                    savedCompanies: [
                        {
                            id: 1,
                            name: 'EcoTech Solutions',
                            description: 'Sustainable IT solutions provider specializing in renewable energy management systems.',
                            location: 'Marina Bay',
                            categories: ['Technology', 'Energy'],
                            topics: ['Renewable Energy', 'Carbon Neutral'],
                            savedDate: new Date().toISOString()
                        },
                        {
                            id: 2,
                            name: 'Green Harvest Cafe',
                            description: 'Farm-to-table organic restaurant with zero waste practices.',
                            location: 'Orchard',
                            categories: ['Food & Beverage'],
                            topics: ['Zero Waste', 'Organic Products', 'Plant-Based'],
                            savedDate: new Date(Date.now() - 86400000).toISOString()
                        }
                    ]
                }
            },
            mounted() {
                this.fetchUserData();
                this.fetchDashboardData();
            },
            methods: {
                async fetchUserData() {
                    const user = sessionStorage.getItem('currentUser');
                    if (!user) {
                        window.location.href = 'login.html';
                        return;
                    }
                    const userData = JSON.parse(user);
                    this.userName = userData.name || 'Guest';
                    this.userProfile.name = userData.name || 'Guest';
                    this.userProfile.email = userData.email || '';
                },

                async fetchDashboardData() {
                    try {
                        const response = await fetch('api/get_user_dashboard.php', {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                window.location.href = 'login.html';
                            }
                            return;
                        }

                        const data = await response.json();

                        if (data.success) {
                            this.userProfile = data.user;
                            this.userName = data.user.name;
                            this.offsetStats = data.offsetStats;
                            this.savedCompanies = data.savedCompanies.map(company => ({
                                ...company,
                                savedDate: new Date(company.savedDate).toISOString()
                            }));
                        }
                    } catch (error) {
                        console.error('Error fetching dashboard data:', error);
                    }
                },

                logout() {
                    sessionStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                },

                async updateProfile() {
                    this.profileMessage = 'Profile updated successfully!';
                    this.userName = this.userProfile.name;
                    sessionStorage.setItem('currentUser', JSON.stringify({
                        name: this.userProfile.name,
                        email: this.userProfile.email
                    }));
                    setTimeout(() => { this.profileMessage = ''; }, 3000);
                },

                removeCompany(companyId) {
                    this.savedCompanies = this.savedCompanies.filter(c => c.id !== companyId);
                    alert('Company removed from your interests!');
                },

                viewBusiness(companyId) {
                    window.location.href = `business_profile.html?id=${companyId}`;
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-SG', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>