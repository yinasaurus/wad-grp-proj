<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Login - Green Business Directory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/login_business.css">
</head>
<body>
    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-leaf me-2"></i>Green Business Directory
                </a>
            </div>
        </nav>

        <div class="container">
            <div class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <i class="fas fa-building"></i>
                        <h2>Business Login</h2>
                        <p class="text-muted">Access your business dashboard</p>
                    </div>

                    <form @submit.prevent="handleLogin">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-envelope me-2 text-muted"></i>Email Address
                            </label>
                            <input 
                                type="email" 
                                class="form-control form-control-lg" 
                                v-model="loginForm.email" 
                                placeholder="business@email.com"
                                required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-lock me-2 text-muted"></i>Password
                            </label>
                            <input 
                                type="password" 
                                class="form-control form-control-lg" 
                                v-model="loginForm.password" 
                                placeholder="Enter your password"
                                required>
                        </div>

                        <div class="alert alert-success" v-if="loginMessage">
                            <i class="fas fa-check-circle me-2"></i>{{ loginMessage }}
                        </div>

                        <div class="alert alert-danger" v-if="loginError">
                            <i class="fas fa-exclamation-circle me-2"></i>{{ loginError }}
                        </div>

                        <button type="submit" class="btn btn-login btn-lg w-100" :disabled="isLoading">
                            <span v-if="!isLoading">
                                <i class="fas fa-sign-in-alt me-2"></i>Sign In
                            </span>
                            <span v-else>
                                <i class="fas fa-spinner fa-spin me-2"></i>Signing in...
                            </span>
                        </button>
                    </form>

                    <div class="text-center mt-4 pt-4" style="border-top: 1px solid #eee;">
                        <p class="mb-0">Don't have an account? 
                            <a href="register_business.html" class="text-decoration-none fw-bold" style="color: var(--accent-green);">
                                Register your business
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loginForm: {
                    email: '',
                    password: ''
                },
                loginMessage: '',
                loginError: '',
                isLoading: false
            }
        },
        methods: {
            async handleLogin() {
                this.loginError = '';
                this.loginMessage = '';
                
                if (!this.loginForm.email || !this.loginForm.password) {
                    this.loginError = 'Please fill in all fields';
                    return;
                }

                this.isLoading = true;
                
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, this.loginForm.email, this.loginForm.password);
                    const user = userCredential.user;
                    console.log('User signed in:', user.uid);
                    
                    // Check businesses collection
                    let userDoc = await getDoc(doc(db, "businesses", user.uid));
                    
                    if (!userDoc.exists()) {
                        const businessesRef = collection(db, "businesses");
                        const q = query(businessesRef, where("email", "==", this.loginForm.email));
                        const querySnapshot = await getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            userDoc = querySnapshot.docs[0];
                        }
                    }
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const businessId = userDoc.id;
                        console.log('Business user found with ID:', businessId);
                        // Establish PHP session via Firebase ID token bridge
                        try {
                            console.log('Step 1: Getting Firebase ID token...');
                            const idToken = await user.getIdToken();
                            console.log('Step 2: Got ID token, calling bridge.php...');
                            
                            const resp = await fetch('api/bridge.php?action=session_login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ idToken })
                            });
                            
                            console.log('Step 3: Got response, status:', resp.status);
                            const data = await resp.json();
                            console.log('Step 4: Response data:', data);
                            
                            if (data.success) {
                                // Use businessId from the session response (MySQL database ID)
                                const mysqlBusinessId = data.business?.businessId || businessId;
                                console.log('Step 5: Success! Business ID:', mysqlBusinessId, 'Full data:', data);
                                
                                // Persist minimal UI state for legacy checks
                                const currentUser = {
                                    name: data.user?.name || (userData.name || this.loginForm.email.split('@')[0]),
                                    email: data.user?.email || this.loginForm.email,
                                    userType: 'business',
                                    businessId: mysqlBusinessId,
                                    userId: data.user?.userId || null
                                };
                                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                                console.log('Step 6: Stored in sessionStorage:', currentUser);
                                
                                this.loginMessage = 'Login successful! Redirecting to dashboard...';
                                
                                // Force redirect immediately
                                console.log('Step 7: Starting redirect to partner_dashboard.html...');
                                setTimeout(() => {
                                    console.log('Step 8: Executing redirect NOW');
                                    window.location.replace('partner_dashboard.html');
                                }, 500);
                            } else {
                                console.error('Step X: Session bridge failed:', data);
                                const errorMsg = data.error || 'Unknown error';
                                this.loginError = 'Could not establish session: ' + errorMsg;
                                this.isLoading = false;
                                return;
                            }
                        } catch (e) {
                            console.error('Step ERROR: Exception caught:', e);
                            console.error('Error details:', e.stack);
                            this.loginError = 'Network error: ' + (e.message || 'Please check your connection and try again.');
                            this.isLoading = false;
                            return;
                        }
                        return;
                    } else {
                        this.loginError = 'This is not a business account. Please use the regular login page.';
                        this.isLoading = false;
                        return;
                    }
                    
                } catch (error) {
                    console.error('Firebase login error:', error);
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        this.loginError = 'Invalid email or password';
                    } else if (error.code === 'auth/invalid-email') {
                        this.loginError = 'Invalid email address';
                    } else {
                        this.loginError = error.message || 'Authentication failed. Please check your credentials.';
                    }
                } finally {
                    this.isLoading = false;
                }
            }
        },
        mounted() {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            if (message) {
                this.loginMessage = decodeURIComponent(message);
            }
        }
    }).mount('#app');
</script>
</body>
</html>